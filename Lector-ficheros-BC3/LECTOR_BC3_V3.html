<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor Profesional FIEBDC-3 (BC3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        /* Estilos de barra de desplazamiento */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .tree-node-selected {
            background-color: #dbeafe !important;
            border-left: 4px solid #2563eb !important;
        }
        
        .list-item-selected {
            background-color: #dbeafe !important;
            border-left: 4px solid #2563eb !important;
        }

        .table-sticky thead th {
            position: sticky;
            top: 0;
            background: #f8fafc;
            z-index: 10;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .chapter-line {
            border-left: 1px dashed #cbd5e1;
            margin-left: 0.75rem;
        }
        
        /* Estilos para la tabla de mediciones detallada */
        .meas-table th { font-size: 10px; text-transform: uppercase; color: #64748b; padding: 6px 4px; }
        .meas-table td { padding: 4px 4px; border-bottom: 1px solid #f1f5f9; }
        .meas-table input { width: 100%; background: transparent; border: none; font-family: monospace; text-align: right; }
    </style>
</head>
<body class="overflow-hidden">

    <div id="loader" class="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-slate-600 font-semibold tracking-wide">Analizando Estructura y Mediciones...</p>
        </div>
    </div>

    <!-- Cabecera -->
    <header class="bg-slate-900 text-white p-4 shadow-xl flex items-center justify-between h-16 relative z-50">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
            </div>
            <div>
                <h1 class="text-lg font-extrabold tracking-tight text-white">BC3 Pro Analyzer</h1>
                <p class="text-[10px] text-blue-400 font-bold uppercase tracking-widest">Ingenier√≠a FIEBDC-3</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <label class="flex items-center gap-2 bg-blue-700 hover:bg-blue-600 px-5 py-2 rounded-full cursor-pointer transition-all shadow-lg active:scale-95 border border-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                <span class="text-xs font-bold uppercase">Importar Fichero</span>
                <input type="file" id="fileInput" class="hidden" accept=".bc3,.txt">
            </label>
        </div>
    </header>

    <!-- Contenedor Principal -->
    <main class="p-4 grid grid-cols-12 gap-4 h-[calc(100vh-64px-40px)]">
        
        <!-- Panel Izquierdo: Pesta√±as (√Årbol / Lista) -->
        <aside class="col-span-12 lg:col-span-4 xl:col-span-3 flex flex-col gap-4 overflow-hidden">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden h-full">
                
                <!-- Pesta√±as Superiores -->
                <div class="flex border-b border-slate-200">
                    <button onclick="switchTab('tree')" id="tab-btn-tree" class="flex-1 py-3 text-[10px] font-bold uppercase tracking-widest text-blue-600 border-b-2 border-blue-600 transition-colors bg-slate-50">
                        Jerarqu√≠a
                    </button>
                    <button onclick="switchTab('list')" id="tab-btn-list" class="flex-1 py-3 text-[10px] font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent hover:text-blue-500 hover:bg-slate-50 transition-colors">
                        Listado Completo
                    </button>
                </div>

                <!-- VISTA √ÅRBOL -->
                <div id="view-tree" class="flex flex-col flex-1 overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h2 class="text-xs font-black uppercase tracking-widest text-slate-400">Estructura del Proyecto</h2>
                        <span id="nodes-count" class="bg-blue-100 text-blue-700 text-[10px] px-2 py-1 rounded-md font-bold">0</span>
                    </div>
                    <div id="tree-container" class="overflow-auto flex-1 p-3 text-sm scroll-smooth bg-slate-50/30 font-medium">
                        <div class="flex flex-col items-center justify-center h-full text-slate-400 space-y-4 px-6 text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="text-xs font-medium italic">Seleccione un archivo BC3 para visualizar la obra.</p>
                        </div>
                    </div>
                </div>

                <!-- VISTA LISTA -->
                <div id="view-list" class="flex flex-col flex-1 overflow-hidden hidden">
                    <div class="p-3 bg-white border-b border-slate-200">
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="Buscar por c√≥digo o descripci√≥n..." class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-medium focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all">
                            <svg class="w-4 h-4 absolute left-3 top-2.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </div>
                    </div>
                    <div id="list-container" class="overflow-auto flex-1 p-0 text-sm bg-slate-50/30">
                        <div class="p-8 text-center text-slate-400 text-xs italic">
                            Escribe para buscar conceptos...
                        </div>
                    </div>
                </div>

            </div>
        </aside>

        <!-- Panel Derecho: Informaci√≥n Detallada -->
        <section class="col-span-12 lg:col-span-8 xl:col-span-9 flex flex-col gap-4 overflow-hidden">
            
            <!-- Cabecera de Selecci√≥n -->
            <div id="selection-header" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 border-l-[6px] border-l-blue-600 transition-all">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex-1 overflow-hidden">
                        <span id="detail-code" class="text-sm font-black font-mono text-white bg-blue-600 px-3 py-1.5 rounded-md uppercase tracking-wide">C√ìDIGO</span>
                        <h2 id="detail-summary" class="text-xl font-extrabold text-slate-800 mt-2 leading-tight truncate">Inicie la carga del presupuesto</h2>
                        <div class="flex items-center gap-4 mt-2">
                            <span id="detail-unit" class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded italic">Ud: -</span>
                            <span id="detail-price" class="text-xs font-bold text-slate-500">Precio Unitario (DC): <span class="text-blue-600 font-black">-</span></span>
                        </div>
                    </div>
                    <div class="bg-slate-50 px-6 py-3 rounded-xl border border-slate-100 text-center md:text-right shrink-0">
                        <p class="text-[10px] text-slate-400 uppercase font-black tracking-widest">Importe Total (DM)</p>
                        <p id="detail-total" class="text-3xl font-black text-slate-900 tabular-nums">0,00 ‚Ç¨</p>
                    </div>
                </div>
            </div>

            <!-- Paneles de Datos -->
            <div class="flex-1 grid grid-rows-2 gap-4 overflow-hidden">
                <!-- Tabla Descompuesto -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-4 bg-blue-500 rounded-full"></div>
                            <h3 class="text-sm font-black text-slate-700 uppercase tracking-tight">Descomposici√≥n de Costes (Unitarios)</h3>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto">
                        <table class="w-full text-sm text-left table-sticky">
                            <thead class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                <tr>
                                    <th class="px-6 py-3 border-b bg-slate-50">C√≥digo</th>
                                    <th class="px-6 py-3 border-b bg-slate-50">Descripci√≥n del Recurso</th>
                                    <th class="px-6 py-3 border-b bg-slate-50 text-center">Ud</th>
                                    <th class="px-6 py-3 border-b bg-slate-50 text-right">Rend.</th>
                                    <th class="px-6 py-3 border-b bg-slate-50 text-right">Precio</th>
                                    <th class="px-6 py-3 border-b bg-slate-50 text-right">Importe</th>
                                </tr>
                            </thead>
                            <tbody id="decomposition-body" class="text-slate-600">
                                <tr><td colspan="6" class="p-12 text-center text-slate-300 italic">Seleccione una partida para ver su descompuesto</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Mediciones y Texto -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 overflow-hidden">
                    <!-- Mediciones (Expandida) -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                         <div class="p-4 bg-slate-50 border-b border-slate-200">
                            <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest">Detalle de Mediciones (~M)</h3>
                        </div>
                        <div id="measurements-content" class="flex-1 overflow-auto p-0 text-[11px]">
                             <table class="w-full text-left table-sticky meas-table">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="text-center w-8">Fase</th>
                                        <th class="w-1/3">Comentario</th>
                                        <th class="text-center w-8">N</th>
                                        <th class="text-center w-12">Longitud</th>
                                        <th class="text-center w-12">Anchura</th>
                                        <th class="text-center w-12">Altura</th>
                                        <th class="w-24">F√≥rmula</th>
                                        <th class="text-right w-16 bg-blue-50/50">Parcial</th>
                                        <th class="text-right w-16 bg-yellow-50/50">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody id="measurements-body" class="text-slate-600 font-mono text-[10px]">
                                    <tr><td colspan="9" class="p-10 text-center text-slate-300 italic font-sans">No hay mediciones</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Descripci√≥n Pliego -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                         <div class="p-4 bg-slate-50 border-b border-slate-200">
                            <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest">Pliego / Texto Largo (~T)</h3>
                        </div>
                        <div id="long-text-content" class="flex-1 overflow-auto p-6 text-sm text-slate-600 leading-relaxed font-medium">
                            <span class="text-slate-300 italic">Seleccione un concepto...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Barra de Estado Inferior -->
    <footer class="bg-white border-t border-slate-200 h-10 px-6 flex items-center justify-between text-[10px] font-bold text-slate-400 uppercase tracking-widest">
        <div class="flex items-center gap-8">
            <span id="status-version">Formato: -</span>
            <span id="status-software">Emisor: -</span>
            <span id="status-currency">Divisa: -</span>
        </div>
        <div class="flex items-center gap-2 text-blue-600">
            <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
            Motor BC3 V3.3 - Totales Estructurales Corregidos
        </div>
    </footer>

    <script>
        /**
         * BC3 ENGINE - PRO VERSION 3.3
         */
        class BC3Engine {
            constructor() {
                this.db = new Map();
                this.measurementsMap = new Map();
                this.metadata = { 
                    software: '', version: '', currency: '‚Ç¨', 
                    dn: 2, dd: 2, ds: 2, dr: 3, di: 2, dp: 2, dc: 2, dm: 2 
                };
                this.rootCode = null;
            }

            reset() {
                this.db.clear();
                this.measurementsMap.clear();
                this.rootCode = null;
            }

            async parse(content) {
                this.reset();
                const lines = content.split(/\r\n|\n|\r/);
                
                // Primera pasada: Conceptos b√°sicos (~C)
                for (let line of lines) {
                    if (!line.startsWith('~C')) continue;
                    const p = line.split('|');
                    const code = p[1]?.trim();
                    if (!code) continue;

                    const data = this.initConcept(code);
                    data.unit = p[2] || '';
                    data.summary = p[3] || '';
                    data.price = parseFloat((p[4] || '0').split('\\')[0].replace(',', '.')) || 0;
                    data.type = p[6] || '0';
                }

                // Segunda pasada: Metadatos (~V, ~K)
                for (let line of lines) {
                    const p = line.split('|');
                    const t = p[0].replace('~', '').toUpperCase();
                    if (t === 'V') { this.metadata.software = p[3]; this.metadata.version = p[2]; }
                    if (t === 'K') { this.parseK(p); }
                }

                // Tercera pasada: Relaciones y Textos Multil√≠nea (~D, ~M, ~T)
                let currentTextConcept = null; // Para rastrear textos multil√≠nea

                for (let line of lines) {
                    const trimmedLine = line.trim();
                    
                    // Detectar si empieza un nuevo registro (termina la lectura de texto anterior)
                    if (trimmedLine.startsWith('~')) {
                        
                        // Si est√°bamos leyendo un texto, limpiamos el car√°cter final '|' si existe
                        if (currentTextConcept && currentTextConcept.description && currentTextConcept.description.endsWith('|')) {
                            currentTextConcept.description = currentTextConcept.description.slice(0, -1);
                        }
                        currentTextConcept = null; 

                        const parts = line.split('|');
                        const tag = parts[0].replace('~', '').toUpperCase();
                        let identifier = parts[1]?.trim();
                        
                        if (!identifier && tag !== 'T') continue;

                        if (tag === 'D') {
                            const parent = this.resolveConcept(identifier);
                            if (!parent) continue;
                            for (let i = 2; i < parts.length; i++) {
                                const tokens = parts[i].split('\\');
                                let j = 0;
                                while (j < tokens.length) {
                                    const childCode = tokens[j]?.trim();
                                    if (childCode) {
                                        parent.children.push({
                                            code: childCode,
                                            factor: parseFloat(tokens[j+1]) || 1,
                                            yield: parseFloat(tokens[j+2]) || 1
                                        });
                                    }
                                    j += 3;
                                }
                            }
                        } else if (tag === 'T') {
                            const concept = this.resolveConcept(identifier);
                            if (concept) {
                                let textPart = parts.slice(2).join('|');
                                concept.description = textPart;
                                currentTextConcept = concept; // Activamos modo lectura multil√≠nea
                            }
                        } else if (tag === 'M') {
                            this.processMeasurementRecord(parts);
                        }
                    } else if (currentTextConcept) {
                        // Si no empieza por ~ y estamos en modo texto, es una l√≠nea de continuaci√≥n
                        currentTextConcept.description += '\n' + line;
                    }
                }
                
                // Limpieza final por si el √∫ltimo registro era texto
                if (currentTextConcept && currentTextConcept.description && currentTextConcept.description.endsWith('|')) {
                    currentTextConcept.description = currentTextConcept.description.slice(0, -1);
                }

                this.identifyRoot();
            }

            parseK(parts) {
                const subK = parts[1] || '';
                const tokens = subK.split('\\').map(t => t.trim()).filter(t => t !== "");
                
                let numericCount = 0;
                const keys = ['dn','dd','ds','dr','di','dp','dc','dm'];
                
                for (let token of tokens) {
                    if (!isNaN(token) && numericCount < 8) {
                        this.metadata[keys[numericCount]] = Math.abs(parseInt(token)) || 2;
                        numericCount++;
                    } else if (isNaN(token)) {
                        this.metadata.currency = token;
                        break; 
                    }
                }
            }

            processMeasurementRecord(parts) {
                let identifier = parts[1]?.trim();
                let rawParent = "";
                let rawChild = identifier;
                
                if (identifier.includes('\\')) {
                    const parts_id = identifier.split('\\');
                    rawChild = parts_id.pop();
                    rawParent = parts_id.join('\\');
                }

                const parentConcept = this.resolveConcept(rawParent);
                const childConcept = this.resolveConcept(rawChild);
                
                const pKey = parentConcept ? parentConcept.code : rawParent;
                const cKey = childConcept ? childConcept.code : rawChild;
                const mKey = `${pKey}|${cKey}`;

                if (!this.measurementsMap.has(mKey)) {
                    this.measurementsMap.set(mKey, { total: 0, lines: [] });
                }
                const mData = this.measurementsMap.get(mKey);
                mData.total = parseFloat((parts[3] || '0').replace(',', '.')) || 0;

                let detailTokens = [];
                for (let i = 4; i < parts.length; i++) {
                    detailTokens = detailTokens.concat(parts[i].split('\\'));
                }

                for (let i = 0; i < detailTokens.length; i += 6) {
                    if (i + 1 >= detailTokens.length) break;
                    const type = detailTokens[i] || '';
                    const comment = detailTokens[i+1] || '';
                    const u = parseFloat((detailTokens[i+2] || '0').replace(',', '.')) || 0;
                    const l = parseFloat((detailTokens[i+3] || '0').replace(',', '.')) || 0;
                    const w = parseFloat((detailTokens[i+4] || '0').replace(',', '.')) || 0;
                    const h = parseFloat((detailTokens[i+5] || '0').replace(',', '.')) || 0;
                    if (type === '' && comment === '' && u === 0 && l === 0 && w === 0 && h === 0) continue;
                    mData.lines.push({ type, comment, units: u, length: l, width: w, height: h });
                }
            }

            initConcept(code) {
                if (!this.db.has(code)) {
                    this.db.set(code, {
                        code, unit: '', summary: '', price: 0, 
                        type: '0', description: '', children: []
                    });
                }
                return this.db.get(code);
            }

            resolveConcept(code) {
                if (!code) return null;
                if (this.db.has(code)) return this.db.get(code);
                const base = code.replace(/#+$/, '');
                if (this.db.has(base + '##')) return this.db.get(base + '##');
                if (this.db.has(base + '#')) return this.db.get(base + '#');
                if (this.db.has(base)) return this.db.get(base);
                return null;
            }

            identifyRoot() {
                let root = Array.from(this.db.keys()).find(k => k.endsWith('##'));
                if (!root) root = Array.from(this.db.keys()).find(k => k.endsWith('#'));
                this.rootCode = root || Array.from(this.db.keys())[0];
            }

            num(val, type) {
                const dec = this.metadata[type.toLowerCase()] || 2;
                if (isNaN(val)) return '-';
                return val.toLocaleString('es-ES', { minimumFractionDigits: dec, maximumFractionDigits: dec });
            }

            formatCurrency(val, type = 'DC') {
                return this.num(val, type) + ' ' + this.metadata.currency;
            }
            
            // Eval√∫a f√≥rmulas BC3 con variables a,b,c,d
            evaluateFormula(expression, u, l, w, h) {
                try {
                    // Normalizar expresi√≥n
                    let expr = expression.toLowerCase();
                    // Reemplazo de coma decimal por punto
                    expr = expr.replace(/,/g, '.');
                    
                    // Reemplazar operador potencia ^ por ** (JS)
                    expr = expr.replace(/\^/g, '**');
                    
                    // Definir variables para el scope de la funci√≥n
                    // Mapeo BC3: a=Unidades, b=Longitud, c=Anchura, d=Altura
                    const a = u || 0;
                    const b = l || 0;
                    const c = w || 0;
                    const d = h || 0;
                    const p = Math.PI;
                    
                    // Crear funci√≥n segura
                    const f = new Function('a', 'b', 'c', 'd', 'p', `return ${expr};`);
                    return f(a, b, c, d, p);
                } catch (err) {
                    console.warn("Error evaluando f√≥rmula: " + expression, err);
                    return 0;
                }
            }
        }

        const engine = new BC3Engine();

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('loader').style.display = 'flex';
            const reader = new FileReader();
            reader.readAsText(file, 'windows-1252');
            reader.onload = async (res) => {
                await engine.parse(res.target.result);
                renderAll();
                document.getElementById('loader').style.display = 'none';
            };
        });

        // B√∫squeda en tiempo real
        document.getElementById('search-input').addEventListener('input', (e) => {
            renderList(e.target.value);
        });

        function switchTab(tab) {
            const treeBtn = document.getElementById('tab-btn-tree');
            const listBtn = document.getElementById('tab-btn-list');
            const viewTree = document.getElementById('view-tree');
            const viewList = document.getElementById('view-list');

            if (tab === 'tree') {
                treeBtn.className = "flex-1 py-3 text-[10px] font-bold uppercase tracking-widest text-blue-600 border-b-2 border-blue-600 transition-colors bg-slate-50";
                listBtn.className = "flex-1 py-3 text-[10px] font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent hover:text-blue-500 hover:bg-slate-50 transition-colors";
                viewTree.classList.remove('hidden');
                viewList.classList.add('hidden');
            } else {
                listBtn.className = "flex-1 py-3 text-[10px] font-bold uppercase tracking-widest text-blue-600 border-b-2 border-blue-600 transition-colors bg-slate-50";
                treeBtn.className = "flex-1 py-3 text-[10px] font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent hover:text-blue-500 hover:bg-slate-50 transition-colors";
                viewList.classList.remove('hidden');
                viewTree.classList.add('hidden');
                
                // Cargar lista si es la primera vez o para actualizar
                renderList(document.getElementById('search-input').value);
            }
        }

        function renderList(filterText = '') {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            
            if (engine.db.size === 0) {
                container.innerHTML = '<div class="p-8 text-center text-slate-400 text-xs italic">No hay datos cargados.</div>';
                return;
            }

            const filter = filterText.toLowerCase();
            let count = 0;
            const maxItems = 500; // Limite de renderizado para evitar bloqueo

            for (const [code, concept] of engine.db) {
                if (filter && !code.toLowerCase().includes(filter) && !concept.summary.toLowerCase().includes(filter)) {
                    continue;
                }

                const div = document.createElement('div');
                div.className = "flex flex-col p-2 border-b border-slate-100 hover:bg-blue-50 cursor-pointer transition-colors";
                div.innerHTML = `
                    <div class="flex justify-between items-baseline mb-1">
                        <span class="font-mono text-[10px] font-bold text-blue-600 bg-blue-50 px-1 rounded">${concept.code}</span>
                        <span class="text-[10px] text-slate-400">${concept.unit || '-'}</span>
                    </div>
                    <div class="text-xs text-slate-700 font-medium truncate">${concept.summary}</div>
                    <div class="text-[10px] text-slate-400 text-right mt-1 font-mono">${engine.formatCurrency(concept.price, 'DC')}</div>
                `;
                
                div.onclick = () => {
                    // Seleccionar nodo pero sin path padre (contexto global)
                    // Quitar selecciones previas visuales en lista
                    document.querySelectorAll('.list-item-selected').forEach(el => el.classList.remove('list-item-selected'));
                    div.classList.add('list-item-selected');
                    selectNode(code, null);
                };

                container.appendChild(div);
                count++;
                if (count >= maxItems) {
                    const more = document.createElement('div');
                    more.className = "p-2 text-center text-xs text-slate-400 italic bg-slate-50";
                    more.innerText = `... y otros ${engine.db.size - count} resultados m√°s. Refina la b√∫squeda.`;
                    container.appendChild(more);
                    break;
                }
            }

            if (count === 0) {
                container.innerHTML = '<div class="p-8 text-center text-slate-400 text-xs italic">No se encontraron resultados.</div>';
            }
        }

        function renderAll() {
            document.getElementById('status-version').innerText = `Formato: ${engine.metadata.version}`;
            document.getElementById('status-software').innerText = `Emisor: ${engine.metadata.software}`;
            document.getElementById('status-currency').innerText = `Divisa: ${engine.metadata.currency}`;
            document.getElementById('nodes-count').innerText = `${engine.db.size}`;

            const container = document.getElementById('tree-container');
            container.innerHTML = '';
            if (engine.rootCode) {
                const rootNode = buildTreeNode(engine.rootCode, "");
                container.appendChild(rootNode);
                selectNode(engine.rootCode, "");
            }
            
            // Si estamos en la pesta√±a lista, actualizarla tambi√©n
            if (!document.getElementById('view-list').classList.contains('hidden')) {
                renderList();
            }
        }

        function buildTreeNode(code, parentCode, level = 0, visited = new Set()) {
            const concept = engine.resolveConcept(code);
            if (!concept) return document.createElement('div');
            
            const visitKey = `${parentCode}->${code}`;
            if (visited.has(visitKey)) return document.createElement('div');
            visited.add(visitKey);

            const container = document.createElement('div');
            const isRoot = concept.code.endsWith('##');
            const isChapter = concept.code.endsWith('#');
            const hasChildren = concept.children.length > 0;

            const row = document.createElement('div');
            row.className = `group flex items-center gap-3 p-2 rounded-xl cursor-pointer hover:bg-white hover:shadow-md transition-all border border-transparent my-0.5 select-none`;
            
            let icon = 'üìÑ';
            let labelClass = 'text-slate-600 font-medium';
            if (isRoot) { icon = 'üèóÔ∏è'; labelClass = 'text-blue-700 font-black text-xs uppercase'; row.classList.add('bg-blue-50/50'); }
            else if (isChapter || hasChildren) { icon = 'üìÇ'; labelClass = 'text-slate-800 font-bold'; }

            row.innerHTML = `
                <span class="flex-shrink-0 w-5 h-5 flex items-center justify-center text-sm">${icon}</span>
                <div class="flex flex-col overflow-hidden">
                    <span class="text-[9px] font-black font-mono text-slate-400 leading-none">${concept.code}</span>
                    <span class="truncate text-[11px] ${labelClass} leading-tight mt-0.5">${concept.summary}</span>
                </div>
            `;

            row.onclick = (e) => {
                e.stopPropagation();
                document.querySelectorAll('.tree-node-selected').forEach(el => el.classList.remove('tree-node-selected'));
                row.classList.add('tree-node-selected');
                selectNode(code, parentCode);
            };

            container.appendChild(row);

            if (hasChildren) {
                const childWrapper = document.createElement('div');
                childWrapper.className = "chapter-line";
                concept.children.forEach(child => {
                    childWrapper.appendChild(buildTreeNode(child.code, code, level + 1, visited));
                });
                container.appendChild(childWrapper);

                row.ondblclick = (e) => {
                    e.stopPropagation();
                    const isHidden = childWrapper.style.display === 'none';
                    childWrapper.style.display = isHidden ? 'block' : 'none';
                };
            }
            return container;
        }

        function selectNode(code, parentCode) {
            const concept = engine.resolveConcept(code);
            if (!concept) return;

            document.getElementById('detail-code').innerText = concept.code;
            document.getElementById('detail-summary').innerText = concept.summary;
            document.getElementById('detail-unit').innerText = `Unidad: ${concept.unit || 'n/a'}`;
            
            // Mostrar (DC) y moneda limpia
            document.getElementById('detail-price').innerHTML = `Precio Unitario (DC): <span class="text-blue-600 font-black">${engine.formatCurrency(concept.price, 'DC')}</span>`;
            
            const pConcept = engine.resolveConcept(parentCode);
            const pKey = pConcept ? pConcept.code : parentCode;
            const cKey = concept.code;
            const mKey = `${pKey}|${cKey}`;
            
            const mData = engine.measurementsMap.get(mKey) || { total: 0, lines: [] };

            // CORRECCI√ìN DE TOTALES
            let totalVal = 0;
            if (concept.code.includes('#')) {
                totalVal = concept.price;
            } else {
                totalVal = concept.price * (mData.total || 0);
            }
            
            document.getElementById('detail-total').innerText = engine.formatCurrency(totalVal, 'DM');

            const decBody = document.getElementById('decomposition-body');
            decBody.innerHTML = concept.children.length === 0 
                ? `<tr><td colspan="6" class="p-12 text-center text-slate-300 italic">Sin descomposici√≥n</td></tr>`
                : '';
            
            concept.children.forEach(child => {
                const cData = engine.resolveConcept(child.code) || { summary: 'No definido', unit: '-', price: 0 };
                const rend = child.factor * child.yield;
                const imp = rend * cData.price;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors cursor-pointer border-b border-slate-100";
                tr.onclick = () => selectNode(child.code, code);
                tr.innerHTML = `
                    <td class="px-6 py-3 font-mono text-[10px] text-blue-600 font-bold">${child.code}</td>
                    <td class="px-6 py-3 text-slate-700">${cData.summary}</td>
                    <td class="px-6 py-3 text-center text-slate-400 font-bold">${cData.unit || '-'}</td>
                    <td class="px-6 py-3 text-right font-mono">${engine.num(rend, 'DR')}</td>
                    <td class="px-6 py-3 text-right">${engine.num(cData.price, 'DC')}</td>
                    <td class="px-6 py-3 text-right font-black text-slate-800">${engine.num(imp, 'DI')}</td>
                `;
                decBody.appendChild(tr);
            });

            // TABLA MEDICIONES EXPANDIDA Y CON LOGICA DE SUBTOTALES
            const mBody = document.getElementById('measurements-body');
            mBody.innerHTML = '';
            if (!mData.lines || mData.lines.length === 0) {
                mBody.innerHTML = `<tr><td colspan="9" class="p-10 text-center text-slate-300 italic font-sans">No hay mediciones para ${concept.code}</td></tr>`;
            } else {
                // Variables de estado para acumular subtotales
                let subtotalParcial = 0;
                let subtotalAcumulado = 0;

                mData.lines.forEach(m => {
                    const isFormula = m.type === '3';
                    const rawComment = m.comment || '';
                    
                    // L√≥gica para Subtotal Parcial (Tipo 1)
                    if (m.type === '1') {
                        mBody.innerHTML += `<tr class="bg-blue-50/50">
                            <td class="text-center text-slate-400">1</td>
                            <td colspan="7" class="px-4 py-1 text-right font-black text-blue-600 uppercase text-[9px] border-b shadow-inner">${rawComment || 'Subtotal Parcial'}</td>
                            <td class="px-4 py-1 text-right font-bold text-blue-800">${engine.num(subtotalParcial, 'DS')}</td>
                        </tr>`;
                        subtotalParcial = 0; // Reiniciamos el parcial tras mostrarlo
                        return;
                    }
                    
                    // L√≥gica para Subtotal Acumulado (Tipo 2)
                    if (m.type === '2') {
                        mBody.innerHTML += `<tr class="bg-yellow-50/50">
                            <td class="text-center text-slate-400">2</td>
                            <td colspan="7" class="px-4 py-1 text-right font-black text-yellow-600 uppercase text-[9px] border-b shadow-inner">${rawComment || 'Subtotal Acumulado'}</td>
                            <td class="px-4 py-1 text-right font-bold text-yellow-800">${engine.num(subtotalAcumulado, 'DS')}</td>
                        </tr>`;
                        return;
                    }

                    // Separaci√≥n estricta: Si es f√≥rmula, NO va en comentario.
                    const comentario = isFormula ? '' : rawComment;
                    const formula = isFormula ? rawComment : '';

                    // C√°lculo del parcial de l√≠nea normal (o tipo 3 con dimensiones)
                    let parcial = 0;
                    
                    // Si es una f√≥rmula (Tipo 3) con contenido, tiene prioridad de evaluaci√≥n
                    if (isFormula && formula) {
                        parcial = engine.evaluateFormula(formula, m.units, m.length, m.width, m.height);
                    } 
                    // Si no, c√°lculo est√°ndar por dimensiones
                    else if (m.units !== 0 || m.length !== 0 || m.width !== 0 || m.height !== 0) {
                        const val = (v) => v === 0 ? 1 : v;
                        parcial = m.units * val(m.length) * val(m.width) * val(m.height);
                    }

                    // Acumulamos
                    subtotalParcial += parcial;
                    subtotalAcumulado += parcial;

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-colors";
                    tr.innerHTML = `
                        <td class="text-center text-slate-400">${m.type || ''}</td>
                        <td>${comentario}</td>
                        <td class="text-center font-bold text-slate-800">${m.units !== 0 ? engine.num(m.units, 'DN') : ''}</td>
                        <td class="text-center text-slate-500">${m.length !== 0 ? engine.num(m.length, 'DD') : ''}</td>
                        <td class="text-center text-slate-500">${m.width !== 0 ? engine.num(m.width, 'DD') : ''}</td>
                        <td class="text-center text-slate-500">${m.height !== 0 ? engine.num(m.height, 'DD') : ''}</td>
                        <td class="text-blue-600 font-medium italic text-[9px]">${formula}</td>
                        <td class="text-right font-bold text-blue-600 bg-blue-50/30">${parcial !== 0 ? engine.num(parcial, 'DS') : ''}</td>
                        <td class="text-right text-slate-300 bg-yellow-50/10">0.00</td> <!-- Subtotal solo se muestra en l√≠neas de resumen -->
                    `;
                    mBody.appendChild(tr);
                });
                mBody.innerHTML += `
                    <tr class="bg-slate-900 text-white shadow-xl relative z-10 border-t-2 border-blue-500 font-sans">
                        <td colspan="7" class="px-4 py-3 text-right font-black uppercase tracking-tighter text-[10px] text-blue-400 italic">Total Medici√≥n (${concept.unit}):</td>
                        <td colspan="2" class="px-4 py-3 text-right font-black text-sm tabular-nums">${engine.num(mData.total, 'DS')}</td>
                    </tr>
                `;
            }

            document.getElementById('long-text-content').innerHTML = concept.description 
                ? concept.description.replace(/\n/g, '<br>') 
                : `<div class="flex flex-col items-center justify-center h-full opacity-30 italic font-normal text-center"><p>No existe informaci√≥n de pliego.</p></div>`;
        }
    </script>
</body>
</html>