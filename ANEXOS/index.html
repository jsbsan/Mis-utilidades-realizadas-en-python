<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control de Pastillas - Python</title>
    
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        .animate-bounce-short { animation: bounce-short 0.5s; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes bounce-short { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-25%); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        .no-select { -webkit-tap-highlight-color: transparent; user-select: none; }
        input[type="time"]::-webkit-calendar-picker-indicator { background: transparent; bottom: 0; color: transparent; cursor: pointer; height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURACIN ---
        // Usamos una ruta relativa para que funcione tanto en localhost como por IP (m贸vil)
        // El servidor Python sirve tanto el HTML como la API en el mismo puerto.
        const API_URL = '/api/pastillas'; 
        
        const getUserId = () => {
            let id = localStorage.getItem('pill_user_id');
            if (!id) {
                id = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('pill_user_id', id);
            }
            return id;
        };

        const setUserId = (newId) => {
            if(newId && newId.length > 3) {
                localStorage.setItem('pill_user_id', newId);
                window.location.reload(); 
            }
        };

        // --- ICONOS ---
        const IconSmile = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>;
        const IconFrown = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>;
        const IconPill = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg>;
        const IconBell = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>;
        const IconBellOff = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5"/><path d="M17 17H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/><line x1="1" y1="1" x2="23" y2="23"/></svg>;
        const IconHome = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const IconInfo = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>;
        const IconServer = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>;
        const IconRotate = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;
        const IconClock = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const IconEdit = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>;
        const IconKey = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>;

        const App = () => {
            const [activeTab, setActiveTab] = useState('home'); 
            const [doses, setDoses] = useState(null); 
            const [triggeredAlarms, setTriggeredAlarms] = useState([]);
            const [isSyncing, setIsSyncing] = useState(false);
            const [syncError, setSyncError] = useState(null);
            
            const userId = getUserId(); 

            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = new Date().toLocaleDateString('es-ES', dateOptions);
            const formattedDate = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
            const todayKey = new Date().toDateString();

            const initialDosesTemplate = [
                { id: 1, label: 'Toma 1', taken: false, time: null, alarmTime: '', alarmEnabled: false },
                { id: 2, label: 'Toma 2', taken: false, time: null, alarmTime: '', alarmEnabled: false },
                { id: 3, label: 'Toma 3', taken: false, time: null, alarmTime: '', alarmEnabled: false },
                { id: 4, label: 'Toma 4', taken: false, time: null, alarmTime: '', alarmEnabled: false },
            ];

            // 1. Cargar datos
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const response = await fetch(`${API_URL}?id=${userId}`);
                        if (!response.ok) throw new Error("Error servidor");
                        
                        const data = await response.json();

                        if (data && data.date) {
                            if (data.date !== todayKey) {
                                console.log("Nuevo d铆a detectado");
                                const resetDoses = data.doses.map(d => ({ ...d, taken: false, time: null }));
                                setDoses(resetDoses);
                                saveToServer(resetDoses, todayKey);
                            } else {
                                setDoses(data.doses);
                            }
                        } else {
                            setDoses(initialDosesTemplate);
                            saveToServer(initialDosesTemplate, todayKey);
                        }
                        setSyncError(null);
                    } catch (err) {
                        console.error("Error conectando a Python:", err);
                        setSyncError("Error conectando al servidor Python");
                        const localSaved = localStorage.getItem('pill_backup_data');
                        setDoses(localSaved ? JSON.parse(localSaved) : initialDosesTemplate);
                    }
                };

                loadData();
                const interval = setInterval(loadData, 5000); 
                return () => clearInterval(interval);
            }, [userId]);

            // 2. Guardar datos
            const saveToServer = async (newDoses, dateVal = todayKey) => {
                setIsSyncing(true);
                const payload = {
                    date: dateVal,
                    doses: newDoses,
                    lastUpdated: new Date().toISOString()
                };

                localStorage.setItem('pill_backup_data', JSON.stringify(newDoses));

                try {
                    const response = await fetch(`${API_URL}?id=${userId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error("Error al guardar");
                    setSyncError(null);
                } catch (err) {
                    console.error("Error guardando:", err);
                    setSyncError("Fallo al guardar en el servidor.");
                } finally {
                    setIsSyncing(false);
                }
            };

            // --- Alarmas y UI ---
            useEffect(() => {
                if (!doses) return;
                const interval = setInterval(() => {
                    const now = new Date();
                    const currentHours = String(now.getHours()).padStart(2, '0');
                    const currentMinutes = String(now.getMinutes()).padStart(2, '0');
                    const currentTimeStr = `${currentHours}:${currentMinutes}`;
                    const currentDay = now.toDateString();

                    doses.forEach(dose => {
                        const alarmKey = `${dose.id}-${currentTimeStr}-${currentDay}`;
                        if (dose.alarmEnabled && dose.alarmTime === currentTimeStr && !dose.taken && !triggeredAlarms.includes(alarmKey)) {
                            triggerAlarm(dose);
                            setTriggeredAlarms(prev => [...prev, alarmKey]);
                        }
                    });
                }, 5000); 
                return () => clearInterval(interval);
            }, [doses, triggeredAlarms]);

            const triggerAlarm = (dose) => {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const osc = context.createOscillator();
                const gain = context.createGain();
                osc.connect(gain);
                gain.connect(context.destination);
                osc.type = "sine";
                osc.frequency.value = 880; 
                gain.gain.setValueAtTime(0.1, context.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.00001, context.currentTime + 0.5);
                osc.start();
                osc.stop(context.currentTime + 0.5);

                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification(`隆Hora de la pastilla!`, { body: `Te toca: ${dose.label}` });
                }
            };

            const toggleDose = (id) => {
                if (!doses) return;
                const newDoses = doses.map(dose => {
                    if (dose.id === id) {
                        const isTaking = !dose.taken;
                        return { ...dose, taken: isTaking, time: isTaking ? new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : null };
                    }
                    return dose;
                });
                setDoses(newDoses);
                saveToServer(newDoses);
            };

            const editLabel = (e, id, currentLabel) => {
                e.stopPropagation();
                const newLabel = window.prompt("Nombre de la toma:", currentLabel);
                if (newLabel && newLabel.trim() !== "") {
                    const newDoses = doses.map(d => d.id === id ? { ...d, label: newLabel.trim() } : d);
                    setDoses(newDoses);
                    saveToServer(newDoses);
                }
            };

            const resetDay = () => {
                if (window.confirm('驴Reiniciar las tomas de hoy?')) {
                    const newDoses = doses.map(d => ({ ...d, taken: false, time: null }));
                    setTriggeredAlarms([]); 
                    setDoses(newDoses);
                    saveToServer(newDoses);
                }
            };

            const updateAlarmTime = (id, time) => {
                const newDoses = doses.map(d => d.id === id ? { ...d, alarmTime: time, alarmEnabled: true } : d);
                setDoses(newDoses);
                saveToServer(newDoses);
            };

            const toggleAlarm = (id) => {
                const newDoses = doses.map(d => {
                    if (d.id === id) {
                        if (!d.alarmEnabled && !d.alarmTime) return d; 
                        return { ...d, alarmEnabled: !d.alarmEnabled };
                    }
                    return d;
                });
                setDoses(newDoses);
                saveToServer(newDoses);
            };

            const handleManualIdChange = () => {
                const code = prompt("Introduce el c贸digo de sincronizaci贸n:", userId);
                if (code && code !== userId) {
                    setUserId(code);
                }
            };

            if (!doses) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-blue-600 text-white flex-col gap-4">
                        <div className="w-12 h-12 border-4 border-white/30 border-t-white rounded-full animate-spin"></div>
                        <p className="animate-pulse font-medium">Conectando a Python...</p>
                        {syncError && <p className="text-red-300 text-sm mt-2">{syncError}</p>}
                    </div>
                );
            }

            const takenCount = doses.filter(d => d.taken).length;
            const progress = (takenCount / doses.length) * 100;

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-2xl overflow-hidden relative">
                    <header className="bg-blue-600 text-white p-6 rounded-b-3xl shadow-lg z-10 relative select-none">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h1 className="text-2xl font-bold flex items-center gap-2">
                                    <IconPill className="w-8 h-8" /> Mi Medicaci贸n
                                </h1>
                                <div className="flex items-center gap-2">
                                    <p className="text-blue-50 text-xl font-bold mt-1">{formattedDate}</p>
                                    {isSyncing ? <IconRotate className="w-4 h-4 animate-spin text-blue-200" /> : <IconServer className="w-4 h-4 text-blue-200" />}
                                </div>
                            </div>
                            {activeTab === 'home' && <button onClick={resetDay} className="p-2 bg-blue-500 hover:bg-blue-400 rounded-full"><IconRotate className="w-5 h-5 text-white" /></button>}
                        </div>
                        {syncError && <div className="bg-red-500/20 border border-red-500/50 rounded-lg p-2 mb-2 text-xs text-red-100 flex items-center gap-2"><span>锔 {syncError}</span></div>}
                        {activeTab === 'home' && (
                            <div className="mt-4 animate-fade-in">
                                <div className="flex justify-between text-xs mb-1 font-medium"><span>Progreso diario</span><span>{takenCount} de {doses.length}</span></div>
                                <div className="w-full bg-blue-800/30 rounded-full h-2.5"><div className="bg-green-400 h-2.5 rounded-full transition-all duration-500 ease-out" style={{ width: `${progress}%` }}></div></div>
                            </div>
                        )}
                    </header>
                    <main className="flex-1 overflow-y-auto bg-slate-50 pb-20">
                        {activeTab === 'home' && (
                            <div className="p-6 space-y-4 animate-fade-in">
                                {doses.map((dose) => (
                                    <div key={dose.id} onClick={() => toggleDose(dose.id)} className={`no-select relative p-4 rounded-2xl border-2 transition-all duration-300 cursor-pointer group shadow-sm active:scale-95 touch-manipulation ${dose.taken ? 'bg-green-50 border-green-500 shadow-green-100' : 'bg-white border-slate-200'}`}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-4">
                                                <div className={`w-14 h-14 rounded-full flex items-center justify-center transition-colors duration-300 ${dose.taken ? 'bg-green-500' : 'bg-red-100'}`}>{dose.taken ? <IconSmile className="w-8 h-8 text-white animate-bounce-short" /> : <IconFrown className="w-8 h-8 text-red-500" />}</div>
                                                <div className="flex flex-col">
                                                    <div className="flex items-center gap-2"><span className={`text-lg font-bold ${dose.taken ? 'text-green-800' : 'text-slate-700'}`}>{dose.label}</span><button onClick={(e) => editLabel(e, dose.id, dose.label)} className="p-1.5 text-slate-400 hover:text-blue-500 rounded-full"><IconEdit className="w-4 h-4" /></button></div>
                                                    <span className={`text-sm ${dose.taken ? 'text-green-600' : 'text-slate-400'}`}>{dose.taken ? '隆Toma realizada!' : 'Pendiente'}</span>
                                                    {dose.alarmEnabled && dose.alarmTime && !dose.taken && <span className="text-xs text-blue-500 flex items-center gap-1 mt-1"><IconBell className="w-3 h-3" /> {dose.alarmTime}</span>}
                                                </div>
                                            </div>
                                            {dose.taken && <div className="flex flex-col items-end animate-fade-in"><div className="flex items-center gap-1 text-green-700 font-mono text-lg font-bold bg-green-100 px-2 py-1 rounded-lg"><IconClock className="w-4 h-4" />{dose.time}</div></div>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        {activeTab === 'alarms' && (
                            <div className="p-6 space-y-4 animate-fade-in">
                                <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-sm text-yellow-800 mb-6 flex items-start gap-2"><IconBell className="w-5 h-5 shrink-0 mt-0.5" /><p>Configura las alertas.</p></div>
                                {doses.map((dose) => (
                                    <div key={dose.id} className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between">
                                        <div className="flex flex-col"><span className="font-bold text-slate-700 text-lg">{dose.label}</span><span className="text-xs text-slate-400">{dose.alarmEnabled ? 'Activada' : 'Desactivada'}</span></div>
                                        <div className="flex items-center gap-3"><div className="relative"><input type="time" value={dose.alarmTime} onChange={(e) => updateAlarmTime(dose.id, e.target.value)} className={`p-2 rounded-lg border-2 font-mono text-lg outline-none transition-colors ${dose.alarmEnabled ? 'border-blue-500 bg-blue-50 text-blue-900' : 'border-slate-200 bg-slate-50 text-slate-400'}`} /></div><button onClick={() => toggleAlarm(dose.id)} className={`w-12 h-7 rounded-full transition-colors relative flex items-center ${dose.alarmEnabled ? 'bg-blue-500' : 'bg-slate-300'}`} disabled={!dose.alarmTime}><div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform ml-1 ${dose.alarmEnabled ? 'translate-x-5' : 'translate-x-0'}`}></div></button></div>
                                    </div>
                                ))}
                                <button onClick={() => { if ("Notification" in window) Notification.requestPermission(); triggerAlarm({label: "Prueba"}); }} className="w-full mt-6 py-3 bg-slate-200 text-slate-600 rounded-xl font-medium hover:bg-slate-300 transition-colors flex justify-center items-center gap-2"><IconBell className="w-4 h-4" /> Probar notificaciones</button>
                            </div>
                        )}
                        {activeTab === 'info' && (
                            <div className="p-6 space-y-6 animate-fade-in text-center">
                                <div className="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm flex flex-col items-center gap-4">
                                    <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center text-4xl animate-bounce-short"></div>
                                    <div><h2 className="text-2xl font-bold text-slate-800">Control de Pastillas</h2><p className="text-blue-500 font-medium bg-blue-50 px-3 py-1 rounded-full text-xs inline-block mt-2">Python Edition</p></div>
                                    <div className="w-full h-px bg-slate-100 my-2"></div>
                                    <div className="bg-slate-50 w-full p-4 rounded-xl text-left"><p className="text-xs text-slate-400 uppercase tracking-wider font-semibold mb-1">Tu C贸digo de Sincronizaci贸n</p><div className="flex justify-between items-center"><p className="text-slate-800 font-mono text-lg font-bold">{userId}</p><button onClick={handleManualIdChange} className="text-blue-600 hover:text-blue-800 bg-blue-100 p-2 rounded-lg"><IconKey className="w-4 h-4" /></button></div></div>
                                    <div className="space-y-1 w-full text-left pt-2"><p className="text-xs text-slate-400 uppercase tracking-wider font-semibold">Autor</p><p className="text-slate-800 font-bold">Julio Sanchez Berro</p></div>
                                    <div className="mt-4 pt-4 border-t border-slate-50 w-full"><p className="text-xs text-slate-400">漏 {new Date().getFullYear()} Todos los derechos reservados.</p></div>
                                </div>
                            </div>
                        )}
                    </main>
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-2 z-50 max-w-md mx-auto rounded-t-2xl shadow-[0_-5px_15px_rgba(0,0,0,0.05)] select-none">
                        <div className="flex justify-around items-center">
                            <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 p-2 rounded-xl w-full transition-colors ${activeTab === 'home' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}><IconHome className="w-6 h-6" /><span className="text-xs font-medium">Tomas</span></button>
                            <button onClick={() => setActiveTab('alarms')} className={`flex flex-col items-center gap-1 p-2 rounded-xl w-full transition-colors ${activeTab === 'alarms' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}>{doses && doses.some(d => d.alarmEnabled) ? <IconBell className="w-6 h-6" /> : <IconBellOff className="w-6 h-6" />}<span className="text-xs font-medium">Alarmas</span></button>
                            <button onClick={() => setActiveTab('info')} className={`flex flex-col items-center gap-1 p-2 rounded-xl w-full transition-colors ${activeTab === 'info' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}><IconInfo className="w-6 h-6" /><span className="text-xs font-medium">Info</span></button>
                        </div>
                    </nav>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>